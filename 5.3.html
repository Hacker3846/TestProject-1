<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON STORAGE v5.1 PRO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.4);
            --primary: #6366f1;
            --success: #22c55e;
            --danger: #ef4444;
            --text: #1e293b;
            --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            margin: 0; color: var(--text);
            padding-bottom: 140px; min-height: 100vh;
        }

        .container { max-width: 600px; margin: 20px auto; padding: 15px; }

        .tabs {
            display: flex; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px);
            padding: 5px; border-radius: 16px; gap: 5px; margin-bottom: 25px;
            border: 1px solid var(--glass-border); position: sticky; top: 20px; z-index: 100;
        }

        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent;
            cursor: pointer; border-radius: 12px; font-weight: 600; color: #64748b; transition: 0.3s;
        }

        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card {
            background: var(--glass); backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 16px; margin-bottom: 16px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07);
        }

        .card-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: 60px 1fr; gap: 10px; margin-top: 15px; }
        .flex-row { display: flex; gap: 10px; margin-top: 15px; }

        input, select, textarea { background: rgba(255, 255, 255, 0.7); border: 1px solid var(--glass-border); padding: 10px; border-radius: 12px; outline: none; font-family: inherit; }

        .btn-add-main { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .full-width { width: 100%; }

        .order-controls { display: flex; gap: 8px; margin-top: 10px; }
        .order-controls select { flex: 2; }
        .order-controls input { width: 60px; text-align: center; }
        .btn-order-add { background: var(--primary); color: white; border: none; width: 42px; height: 42px; border-radius: 12px; font-size: 20px; cursor: pointer; }

        .order-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 12px; background: rgba(255,255,255,0.4); border-radius: 10px; margin-bottom: 6px; 
            font-size: 14px; border: 1px solid rgba(255,255,255,0.5);
        }

        .history-item {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.4); padding: 8px 12px; border-radius: 12px;
            margin-bottom: 5px; font-size: 11px;
        }
        .history-controls { display: flex; align-items: center; gap: 4px; }
        .btn-mini { width: 32px; height: 32px; border-radius: 8px; border: none; background: white; color: var(--primary); cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .status-btn { border: none; padding: 8px 12px; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; color: white; }
        
        .details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.05); }
        .details.show { display: block; }

        .total-badge { background: var(--primary); color: white; padding: 10px 15px; border-radius: 12px; margin-top: 15px; display: flex; justify-content: space-between; font-weight: 800; }
        .revenue-badge { background: #8b5cf6; color: white; padding: 15px; border-radius: 16px; margin-top: 15px; display: flex; flex-direction: column; gap: 8px; font-weight: 700; }
        .revenue-line { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        
        .money-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .money-field { background: white; padding: 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .money-field input { width: 100%; border: none; font-size: 16px; background: transparent; margin-top: 5px; }

        .btn-copy { flex: 1; padding: 15px; background: rgba(255,255,255,0.5); border: 2px dashed var(--primary); color: var(--primary); border-radius: 16px; font-weight: bold; cursor: pointer; }
        .btn-danger-outline { padding: 15px; background: transparent; border: 2px solid var(--danger); color: var(--danger); border-radius: 16px; font-weight: bold; cursor: pointer; width: 60px; display: flex; align-items: center; justify-content: center; }
        
        .footer {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 40px); max-width: 560px; background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(15px); padding: 15px 25px; border-radius: 24px;
            display: flex; justify-content: space-between; align-items: center; color: white; z-index: 2000;
        }
        .badge-count { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="btn-warehouse" onclick="switchTab('warehouse')">üì¶ –°–∫–ª–∞–¥</button>
        <button class="tab-btn" id="btn-customers" onclick="switchTab('customers')">üë• –ó–∞–∫–∞–∑—á–∏–∫–∏</button>
        <button class="tab-btn" id="btn-incoming" onclick="switchTab('incoming')">
            üîî –ó–∞–∫–∞–∑—ã <span id="new-orders-badge" class="badge-count">0</span>
        </button>
    </div>

    <div id="warehouse" class="tab-content active">
        <div class="card">
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
            <div class="form-grid">
                <input type="text" id="p-icon" placeholder="üçé">
                <input type="text" id="p-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <input type="number" id="p-qty" placeholder="–ù–∞—á. –∫–æ–ª-–≤–æ">
                <input type="number" id="p-price" placeholder="–¶–µ–Ω–∞ –∑–∞ –µ–¥.">
            </div>
            <button class="btn-add-main full-width" style="margin-top:15px" onclick="addProduct()">–°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£</button>
        </div>
        <div id="products-list"></div>
        <div id="warehouse-revenue-box"></div>
        <div class="flex-row">
            <button class="btn-copy" onclick="copyWarehouse()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫–ª–∞–¥</button>
            <button class="btn-danger-outline" onclick="resetWarehouse()">üóë</button>
        </div>
    </div>

    <div id="customers" class="tab-content">
        <div class="card">
            <h3>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑—á–∏–∫</h3>
            <div class="flex-row">
                <input type="text" id="c-name" placeholder="–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞" style="flex:1;">
                <button class="btn-add-main" onclick="addCustomer()">+</button>
            </div>
        </div>
        <div id="customers-list"></div>
        <div id="customers-revenue-box"></div>
        <div class="flex-row">
            <button class="btn-copy" onclick="copyOrders()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã</button>
            <button class="btn-danger-outline" onclick="resetAllCustomersData()">üóë</button>
        </div>
    </div>

    <div id="incoming" class="tab-content">
        <div class="card">
            <h3>–í—Ö–æ–¥—è—â–∏–µ —Å —Å–∞–π—Ç–∞</h3>
            <div id="incoming-orders-list"></div>
        </div>
    </div>
</div>

<div class="footer">
    <span>üíµ –ù–ê –†–£–ö–ê–•:</span>
    <input type="number" id="cash-input" oninput="saveCash()" style="background:rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2); width:100px; padding:5px; border-radius:10px;">
</div>

<script>
    // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–¢–≤–æ—è –±–∞–∑–∞)
    const firebaseConfig = {
        apiKey: "AIzaSyBH0g83qEUERiDBjgMgRnSJ-s2lvpPtkz4",
        authDomain: "vitrina-e0a00.firebaseapp.com",
        databaseURL: "https://vitrina-e0a00-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "vitrina-e0a00",
        storageBucket: "vitrina-e0a00.firebasestorage.app",
        messagingSenderId: "182787477088",
        appId: "1:182787477088:web:35827926e1e885bb0bfd05"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let db = { products: [], customers: [], incomingOrders: [], cash: 0, comment: "" };
    let expandedCards = new Set();

    database.ref('skladData').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            db = data;
            if (!db.products) db.products = [];
            if (!db.customers) db.customers = [];
            if (!db.incomingOrders) db.incomingOrders = [];
            renderApp();
        }
    });

    function saveData() { database.ref('skladData').set(db); }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById(`btn-${tabId}`).classList.add('active');
    }

    function toggleDetails(id, prefix) {
        const key = `${prefix}-${id}`;
        if (expandedCards.has(key)) expandedCards.delete(key);
        else expandedCards.add(key);
        renderApp();
    }

    // --- –¢–û–í–ê–†–´ ---
    function addProduct() {
        const name = document.getElementById('p-name').value;
        const qty = parseInt(document.getElementById('p-qty').value) || 0;
        const price = parseFloat(document.getElementById('p-price').value) || 0;
        const icon = document.getElementById('p-icon').value || 'üì¶';
        if (!name) return;
        const now = new Date();
        db.products.push({
            id: Date.now(), icon, name, price, hidden: false,
            history: qty !== 0 ? [{ id: Date.now()+1, qty: qty, date: now.toLocaleDateString(), time: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }] : []
        });
        saveData();
    }

    function toggleVisibility(pId) {
        const p = db.products.find(x => x.id === pId);
        if (p) { p.hidden = !p.hidden; saveData(); }
    }

    function addSupply(pId) {
        const amount = parseInt(prompt("–°–∫–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ–∑–ª–∏?"));
        if (isNaN(amount)) return;
        const p = db.products.find(x => x.id === pId);
        const now = new Date();
        if(!p.history) p.history = [];
        p.history.push({ id: Date.now(), qty: amount, date: now.toLocaleDateString(), time: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
        saveData();
    }

    function updateSupplyQty(pId, sId, delta) {
        const p = db.products.find(x => x.id === pId);
        const s = p.history.find(h => h.id === sId);
        if (s) { s.qty += delta; saveData(); }
    }

    function removeSupply(pId, sId) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) {
            const p = db.products.find(x=>x.id===pId);
            p.history = p.history.filter(h=>h.id!==sId);
            saveData();
        }
    }

    // --- –ó–ê–ö–ê–ó–ß–ò–ö–ò ---
    function addCustomer() {
        const name = document.getElementById('c-name').value;
        if (!name) return;
        db.customers.push({ id: Date.now(), name, orders: [], payCard: 0, payCash: 0 });
        saveData();
        document.getElementById('c-name').value = '';
    }

    function deleteCustomer(cId) {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫–∞?")) {
            db.customers = db.customers.filter(c => c.id !== cId);
            saveData();
        }
    }

    function resetCustomerData(cId) {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑—ã –∏ –¥–µ–Ω—å–≥–∏?")) {
            const c = db.customers.find(x => x.id === cId);
            if (c) { c.orders = []; c.payCard = 0; c.payCash = 0; saveData(); }
        }
    }

    function addToOrder(cId) {
        const selEl = document.getElementById(`sel-${cId}`);
        const qtyEl = document.getElementById(`qty-${cId}`);
        const pId = parseInt(selEl.value);
        const q = parseInt(qtyEl.value) || 0;
        if (!pId || q === 0) return;
        const c = db.customers.find(x => x.id === cId);
        if(!c.orders) c.orders = [];
        const ex = c.orders.find(y => y.productId === pId);
        if(ex) ex.qty += q; else c.orders.push({productId: pId, qty: q});
        saveData();
    }

    function updateOrderQty(cId, pId, delta) {
        const c = db.customers.find(x => x.id === cId);
        const o = c.orders.find(x => x.productId === pId);
        if (o) { o.qty = Math.max(1, o.qty + delta); saveData(); }
    }

    function deleteFromOrder(cId, pId) {
        const c = db.customers.find(x => x.id === cId);
        c.orders = c.orders.filter(o => o.productId !== pId);
        saveData();
    }

    function updateMoney(cId, field, val) {
        const c = db.customers.find(x => x.id === cId);
        if (c) { c[field] = parseInt(val) || 0; saveData(); }
    }

    function approveRemoteOrder(ordId) {
        const ord = db.incomingOrders.find(x => x.id === ordId);
        if (!ord) return;
        let c = db.customers.find(x => x.name === ord.clientName);
        if (!c) {
            c = { id: Date.now(), name: ord.clientName, orders: [], payCard: 0, payCash: 0 };
            db.customers.push(c);
        }
        ord.items.forEach(item => {
            const p = db.products.find(x => x.name === item.name);
            if (p) {
                if(!p.history) p.history = [];
                p.history.push({ id: Date.now()+Math.random(), qty: -item.qty, date: new Date().toLocaleDateString(), time: "–°–∞–π—Ç: "+ord.clientName });
                const ex = c.orders.find(o => o.productId === p.id);
                if (ex) ex.qty += item.qty; else c.orders.push({ productId: p.id, qty: item.qty });
            }
        });
        db.incomingOrders = db.incomingOrders.filter(x => x.id !== ordId);
        saveData();
    }

    // --- –†–ï–ù–î–ï–† ---
    function renderApp() {
        const pList = document.getElementById('products-list');
        const cList = document.getElementById('customers-list');
        const iList = document.getElementById('incoming-orders-list');
        const badge = document.getElementById('new-orders-badge');

        // –°–∫–ª–∞–¥
        pList.innerHTML = db.products.map(p => {
            const total = (p.history || []).reduce((s, h) => s + h.qty, 0);
            const isExpanded = expandedCards.has(`pdet-${p.id}`);
            const isHidden = p.hidden || false;
            return `
                <div class="card" style="${isHidden ? 'opacity:0.6; border-left:4px solid #cbd5e1;' : ''}">
                    <div class="card-header" onclick="toggleDetails(${p.id}, 'pdet')">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="font-size:24px;">${p.icon}</span>
                            <div>
                                <h3 style="margin:0; text-decoration:${isHidden ? 'line-through' : 'none'}">${p.name}</h3>
                                <b>${total} —à—Ç</b>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="status-btn" style="background:${isHidden ? '#94a3b8' : 'var(--primary)'}" onclick="event.stopPropagation(); toggleVisibility(${p.id})">${isHidden ? 'üëÅ‚Äçüó®' : 'üëÅ'}</button>
                            <button class="status-btn" style="background:var(--danger)" onclick="event.stopPropagation(); if(confirm('–£–¥–∞–ª–∏—Ç—å?')){db.products=db.products.filter(x=>x.id!==${p.id}); saveData();}">üóë</button>
                        </div>
                    </div>
                    <div class="details ${isExpanded ? 'show' : ''}">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>–¶–µ–Ω–∞: ${p.price} ‚ÇΩ</span>
                            <button class="btn-mini" onclick="addSupply(${p.id})" style="width:auto; padding:0 10px;">+ –ü–æ—Å—Ç–∞–≤–∫–∞</button>
                        </div>
                        ${(p.history || []).map(h => `
                            <div class="history-item">
                                <span>${h.qty}—à—Ç <small>${h.date} ${h.time || ''}</small></span>
                                <div class="history-controls">
                                    <button class="btn-mini" onclick="updateSupplyQty(${p.id},${h.id},-1)">-</button>
                                    <button class="btn-mini" onclick="updateSupplyQty(${p.id},${h.id},1)">+</button>
                                    <button class="btn-mini" style="color:red" onclick="removeSupply(${p.id},${h.id})">‚úï</button>
                                </div>
                            </div>`).reverse().join('')}
                    </div>
                </div>`;
        }).join('');

        // –ó–∞–∫–∞–∑—á–∏–∫–∏
        const opts = db.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        cList.innerHTML = db.customers.map(c => {
            let sum = 0;
            const isExpanded = expandedCards.has(`cdet-${c.id}`);
            let ords = (c.orders || []).map(o => {
                const p = db.products.find(x => x.id === o.productId);
                if (!p) return '';
                sum += p.price * o.qty;
                return `
                <div class="order-item">
                    <span>${p.name} (${o.qty}—à—Ç)</span>
                    <div class="history-controls">
                        <button class="btn-mini" onclick="updateOrderQty(${c.id},${p.id},-1)">-</button>
                        <button class="btn-mini" onclick="updateOrderQty(${c.id},${p.id},1)">+</button>
                        <button class="btn-mini" style="color:red" onclick="deleteFromOrder(${c.id},${p.id})">‚úï</button>
                    </div>
                </div>`;
            }).join('');
            return `
                <div class="card">
                    <div class="card-header" onclick="toggleDetails(${c.id}, 'cdet')">
                        <h3 style="margin:0">üë§ ${c.name}</h3>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-mini" onclick="event.stopPropagation(); resetCustomerData(${c.id})">üîÑ</button>
                            <button class="btn-mini" style="color:var(--danger)" onclick="event.stopPropagation(); deleteCustomer(${c.id})">üóë</button>
                        </div>
                    </div>
                    <div class="details ${isExpanded ? 'show' : ''}">
                        <div class="order-controls">
                            <select id="sel-${c.id}">${opts}</select>
                            <input type="number" id="qty-${c.id}" value="0">
                            <button class="btn-order-add" onclick="addToOrder(${c.id})">+</button>
                        </div>
                        <div style="margin-top:10px;">${ords}</div>
                        <div class="total-badge"><span>–ò–¢–û–ì–û:</span><span>${sum} ‚ÇΩ</span></div>
                        <div class="money-row">
                            <div class="money-field">–ü–ï–†–ï–í–û–î<input type="number" value="${c.payCard||0}" onchange="updateMoney(${c.id}, 'payCard', this.value)"></div>
                            <div class="money-field">–ù–ê–õ<input type="number" value="${c.payCash||0}" onchange="updateMoney(${c.id}, 'payCash', this.value)"></div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        // –í—Ö–æ–¥—è—â–∏–µ
        const incoming = db.incomingOrders || [];
        badge.style.display = incoming.length ? 'block' : 'none';
        badge.innerText = incoming.length;
        iList.innerHTML = incoming.map(ord => `
            <div class="card" style="border-left:4px solid var(--primary)">
                <b>${ord.clientName}</b><br><small>${ord.date}</small>
                <div style="margin:10px 0">${ord.items.map(i => `‚Ä¢ ${i.name}: ${i.qty}—à—Ç`).join('<br>')}</div>
                <button class="btn-add-main full-width" onclick="approveRemoteOrder(${ord.id})">–ü–†–ò–ù–Ø–¢–¨</button>
            </div>`).join('');

        updateTotals();
    }

    function updateTotals() {
        let warehouseSum = 0, nalSum = 0, cardSum = 0;
        db.products.forEach(p => warehouseSum += p.price * (p.history || []).reduce((s,h)=>s+h.qty, 0));
        db.customers.forEach(c => { nalSum += (c.payCash || 0); cardSum += (c.payCard || 0); });
        
        const content = `
            <div class="revenue-badge">
                <div class="revenue-line"><span>–ù–∞–ª:</span><span>${nalSum.toLocaleString()} ‚ÇΩ</span></div>
                <div class="revenue-line"><span>–ü–µ—Ä–µ–≤–æ–¥:</span><span>${cardSum.toLocaleString()} ‚ÇΩ</span></div>
                <div class="revenue-line" style="opacity:0.7; font-size:0.9em; margin-top:5px; border-top:1px dashed rgba(255,255,255,0.3); padding-top:5px;"><span>–°–∫–ª–∞–¥:</span><span>${warehouseSum.toLocaleString()} ‚ÇΩ</span></div>
                <textarea class="comment-field" style="width:100%; margin-top:10px; background:rgba(0,0,0,0.1); color:white; border:none; border-radius:10px; padding:10px;" placeholder="üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." onchange="db.comment=this.value; saveData()">${db.comment || ''}</textarea>
            </div>`;
        
        document.getElementById('warehouse-revenue-box').innerHTML = content;
        document.getElementById('customers-revenue-box').innerHTML = content;
        document.getElementById('cash-input').value = db.cash || 0;
    }

    function saveCash() { db.cash = document.getElementById('cash-input').value; saveData(); }
    function resetWarehouse() { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å —Å–∫–ª–∞–¥?")) { db.products = []; saveData(); } }
    function resetAllCustomersData() { if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö?")) { db.customers = []; saveData(); } }

    function copyWarehouse() {
        let txt = db.products.map((p, i) => `${i+1}: ${p.icon} ${p.name} - ${(p.history || []).reduce((s,h)=>s+h.qty,0)}—à—Ç`).join('\n');
        navigator.clipboard.writeText(txt); alert("–ö–æ–ø–∏—è –≥–æ—Ç–æ–≤–∞");
    }

    function copyOrders() {
        let txt = db.customers.map((c, i) => {
            const items = (c.orders || []).map(o => {
                const p = db.products.find(x => x.id === o.productId);
                return p ? `${p.name}(${o.qty}—à—Ç)` : '';
            }).join(', ');
            return `${i+1}: üë§ ${c.name} -> ${items}`;
        }).join('\n');
        navigator.clipboard.writeText(txt); alert("–ó–∞–∫–∞–∑—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã");
    }
</script>
</body>
</html>
